
wrapper.silhouette.simple <- function(X, X.cluster){
    X.DF <- Spearman_distance(X)
    X.DF_clu <- Add_Cluster_metadata(X.DF,  X.cluster)
    X.SC <- Slhouette_coef_df(X.DF_clu)
    return(mean(X.SC$silhouette.coef))
}  

df.get_cluster <- function(df){
    # for sparse add filter on result
    
    # X
    clust.X <- df %>% as.data.frame() %>% 
        rownames_to_column("molecule") %>% 
        gather(comp, value, -molecule) %>%
        filter(value != 0) %>% # sparse
        group_by(molecule) %>% mutate(val_abs = abs(value))
    
    clust.X.abs <- clust.X %>% dplyr::summarise(val_abs = max(val_abs))
    
    clust.X  <- clust.X  %>% 
        inner_join(clust.X.abs, by = c("molecule" = "molecule", "val_abs" = "val_abs")) %>%
        dplyr::select(-val_abs) %>% 
        mutate(comp = comp %>% str_remove("comp ") %>% as.numeric) %>%
        mutate(cluster = sign(value)*comp) %>% dplyr::select(c(molecule, cluster))
    
    return(clust.X)
}

#test 07022019 keepX = c(35,6), keepY = c(10,7)
# here I choose to select an arbitrary number of OTUs and metabolites in each data set
spls.res = spls(X = X1, Y = X2, keepX=c(20,12), keepY=c(8,8), ncomp = ncomp, mode = 'regression', scale = TRUE)
plotIndiv(spls.res) # no possible if ncomp =10 OTUs1
plotVar(spls.res)
plotArrow(spls.res)

####################
## Antoine's input
####################

### silhouette coef for the block.pls
# concat data to compute silhouette
X <- cbind(X1,X2) %>% as.data.frame()
# get cluster
X.block <- do.call("rbind",spls.res$loadings)
X.cluster <- df.get_cluster(X.block)
X.filter <- X %>% dplyr::select(X.cluster$molecule)
wrapper.silhouette.simple(X.filter, X.cluster)

# no sparse 
spls.res_nosparse = spls(X = X1, Y = X2, ncomp = ncomp, mode = 'regression', scale = TRUE)
### silhouette coef for the block.pls
# get cluster
X.block <- do.call("rbind",spls.res_nosparse$loadings)
X.cluster <- df.get_cluster(X.block)
wrapper.silhouette.simple(X, X.cluster)



###################
# block PLS

### silhouette coef for the block.pls
# concat data to compute silhouette
Liste=list(OTU=OTU_data, metabo=GCMS_data)
X <- do.call("cbind",Liste %>% lapply(as.data.frame)) %>% cbind(Y)
names(X) <- lapply(Liste, colnames) %>% unlist %>% as.vector() %>% c(colnames(Y))
# get cluster
X.block <- do.call("rbind",res.block$loadings)
X.cluster <- df.get_cluster(X.block)
X.filter <- X %>% dplyr::select(X.cluster$molecule)
wrapper.silhouette.simple(X.filter, X.cluster)

# no sparse 
res.block_nosparse = block.pls(X = Liste, Y=Y, indY = 3, ncomp = 2, mode = "regression")
### silhouette coef for the block.pls
# get cluster
X.block <- do.call("rbind",res.block_nosparse$loadings)
X.cluster <- df.get_cluster(X.block)
wrapper.silhouette.simple(X, X.cluster)